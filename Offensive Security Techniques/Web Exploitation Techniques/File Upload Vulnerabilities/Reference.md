# What is it?
When a site allows for files to be uploaded, it checks what the file type is first and if it is executable (.php, .exe. or static HTML page), if it is executable, and the server can execute it, it will run the script. If the file is executable and the server is not configured to execute that file type, it may respond with an error or plain text of the file itself.
## What defines the file type?
`Content-Type` response header may provide clues as to what kind of file the server thinks it has served.
# Exploiting
## Tips
- Web servers often use the `filename` field in `multipart/form-data` requests to determine the name and location where the file should be saved.
## Process
1. In Burp -> Proxy -> HTTP History, filter out images in the filters, find the request where you uploaded the file and send to Repeater
2. Create and upload your malicious file to the File Upload section
3. In Repeater, change the file path from the file you originally sent to the malicious file you uploaded, send in repeater, view the response
## Only JPG or PNG files allowed
1. Repeat steps 1 & 2 in process^^
2. Verify when uploading your file you can only submit certain file types
3. In Burp Proxy History, find the POST request that was used to submit the file upload and send to Repeater, and open the POST request in Repeater
4. Change the `Content-Type` **(IN THE BODY OF THE POST REQUEST WHERE YOUR FILE IS)** header to `image/jpeg` and send the file (check if the response was successful)
5. Switch to the other Repeater tab with the GET request of your image and replace the image name with the name of your malicious file, then send the request
## Preventing File Execution in user-accessible directories
1. Upload non-malicious file, send GET request that fetched your image `/files/avatars/<YOUR-IMAGE>` to Repeater
2. Create a malicious file and upload this and see if the website allows you to upload this file
3. In Burp, go to Repeater and change the `YOUR-IMAGE` file in the GET request where it says `/files/avatars/<YOUR-IMAGE>` to the name of your malicious file `exploit.php`.
4. It server just returns the contents of the malicious file as text instead of running it, continue
5. Find the `POST` request for obtaining the location of the file upload (ex: `POST /my-account/avatar/`, should be the file that was used to submit the file) and send to Repeater
6. Find the part of the body in the `POST` request that requests the malicious file. In the `Content-Disposition` header, change the `filename` to a directory traversal sequence
	- `Content-Disposition: form-data; name="avatar"; filename="../exploit.php"`
7. Send. if it says something along `The file avatars/exploit.php has been uploaded`, this means we need to URL encode the forward slash. Do this with `%2f` then send again
8. In Burps proxy history, find the `GET /files/avatars/..%2fexploit.php` request, send to Repeater, and observe that the file was ran
## Insufficient Blacklisting of Dangerous File Types
Some sites may blacklist potentially dangerous file extensions
- this is insufficient, as there is so many different ways to bypass blacklists
	- One way would to use alternative file extensions that are still executable, such as .php5
### Overriding the server configuration
Developers can make directory-specific configuration on IIS servers using a `web.config` file. This might include directives which in one case allows JSON files to be served to users.
- You may occasionally find servers that fail to stop you from uploading your own malicious configuration file. In this case, even if the file extension you need is blacklisted, you may be able to trick the server into mapping an arbitrary, custom file extension to an executable MIME type.
